services:
  db:
    image: postgres:{{ kea.backend.opts.version }}
    restart: unless-stopped
    volumes:
      - {{ service.paths.db.data }}:/var/lib/postgresql/data
    networks:
      - db0
    environment:
      - POSTGRES_DB={{ kea.backend.opts.name }}
      - POSTGRES_USER={{ kea.backend.opts.username }}
      - POSTGRES_PASSWORD={{ kea.backend.opts.password }}
  kea:
    image: {{ image.repository.url }}/{{ image.repository.name }}:{{ image.repository.tag }}
    restart: unless-stopped
    depends_on: [ db ]
    cap_add:
      - NET_ADMIN
      - NET_RAW
    privileged: true
    user: {{ image.uid }}:{{ image.gid }}
    volumes:
      - {{ service.paths.kea.config }}:/etc/kea
      - {{ service.paths.kea.log }}:/var/log/kea
      - {{ service.paths.supervisor.config }}:/etc/supervisor
      - {{ service.paths.supervisor.log }}:/var/log/supervisor
    networks:
      db0:
      mgmt0:
        ipv4_address: {{ service.networking.mgmt.ipv4.address }}
      service0:
        ipv4_address: {{ service.networking.service.ipv4.address }}
    ports:
      - {{ service.ports.tcp.http }}:{{ service.ports.tcp.http }}
    env_file:
      - .env
networks:
  db0:
    name: db0
    driver: bridge
  mgmt0:
    name: mgmt0
    driver: ipvlan
    driver_opts:
      ipvlan_mode: l2
      parent: {{ service.networking.mgmt.interface }}
    ipam:
      driver: default
      config:
        - subnet: {{ service.networking.mgmt.ipv4.address }}/{{ service.networking.mgmt.ipv4.netmask }}
          gateway: {{ service.networking.mgmt.ipv4.gateway }}
  service0:
    name: service0
    driver: ipvlan
    driver_opts:
      ipvlan_mode: l2
      parent: {{ service.networking.service.interface }}
    ipam:
      driver: default
      config:
        - subnet: {{ service.networking.service.ipv4.address }}/{{ service.networking.service.ipv4.netmask }}
          gateway: {{ service.networking.service.ipv4.gateway }}