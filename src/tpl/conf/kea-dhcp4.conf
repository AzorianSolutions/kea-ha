{% if kea.ha.enabled %}
  {% if kea.ha.mode == "primary" %}
    {% set ha_node_name = "node1" %}
    {% set ha_peer1_ip = service.networking.mgmt.ipv4.address %}
    {% set ha_peer2_ip = kea.ha.peer.ipv4.address %}
  {% else %}
    {% set ha_node_name = "node2" %}
    {% set ha_peer1_ip = kea.ha.peer.ipv4.address %}
    {% set ha_peer2_ip = service.networking.mgmt.ipv4.address %}
  {% endif %}
{% endif %}{
    "Dhcp4": {
        "subnet4": [
            {
                "id": 1,
                "interface": "{{ image.service.interface }}",
                "subnet": "192.168.1.0/24",
                "pools": [
                    {
                        "pool": "192.168.1.10-192.168.1.254"
                    }
                ]
            }
        ],
        "interfaces-config": {
            "interfaces": [
                "{{ image.service.interface }}"
            ],
            "service-sockets-max-retries": 5,
            "service-sockets-retry-wait-time": 10000,
            "service-sockets-require-all": false
        },
        "control-socket": {
            "socket-type": "unix",
            "socket-name": "/run/kea/control_socket_4"
        },
        "renew-timer": 900,
        "rebind-timer": 1800,
        "valid-lifetime": 3600,
        "loggers": [
            {
                "name": "kea-dhcp4.dhcp4",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "stdout"
                    }
                ]
            },
            {
                "name": "kea-dhcp4",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.log",
                        "flush": true,
                        "maxsize": 1048576,
                        "maxver": 10
                    }
                ]
            },
            {
                "name": "kea-dhcp4.dhcp4",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.dhcp4",
                        "flush": true,
                        "maxsize": 1048576,
                        "maxver": 10
                    }
                ]
            },
            {
                "name": "kea-dhcp4.dhcpsrv",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.dhcpsrv",
                        "flush": true,
                        "maxsize": 1048576,
                        "maxver": 10
                    }
                ]
            },
            {
                "name": "kea-dhcp4.hooks",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.hooks",
                        "flush": true,
                        "maxsize": 1048576,
                        "maxver": 10
                    }
                ]
            },
            {
                "name": "kea-dhcp4.ha-hooks",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.ha-hooks",
                        "flush": true,
                        "maxsize": 1048576,
                        "maxver": 10
                    }
                ]
            },
            {
                "name": "kea-dhcp4.hosts",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.hosts",
                        "flush": true,
                        "maxsize": 1048576,
                        "maxver": 10
                    }
                ]
            },
            {
                "name": "kea-dhcp4.leases",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.leases",
                        "flush": true,
                        "maxsize": 1048576,
                        "maxver": 10
                    }
                ]
            },
            {
                "name": "kea-dhcp4.packets",
                "severity": "{{ kea.logging.severity }}",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.packets",
                        "flush": true,
                        "maxsize": 1048576,
                        "maxver": 10
                    }
                ]
            }
        ],
        "lease-database": {
            "type":  "{{ kea.backend.type }}",
            "host":  "{{ kea.backend.opts.host }}",
            "port": {{ kea.backend.opts.port }},
            "name":  "{{ kea.backend.opts.name }}",
            "user":  "{{ kea.backend.opts.username }}",
            "password":  "{{ kea.backend.opts.password }}",
            "max-reconnect-tries": 5,
            "reconnect-wait-time": 5000,
            "on-fail": "serve-retry-exit"
        },
        "hosts-database": {
            "type":  "{{ kea.backend.type }}",
            "host":  "{{ kea.backend.opts.host }}",
            "port": {{ kea.backend.opts.port }},
            "name":  "{{ kea.backend.opts.name }}",
            "user":  "{{ kea.backend.opts.username }}",
            "password":  "{{ kea.backend.opts.password }}",
            "max-reconnect-tries": 5,
            "reconnect-wait-time": 5000,
            "on-fail": "serve-retry-exit"
        }{% if kea.ha.enabled %},
        "hooks-libraries": [
            {
                "library": "/usr/lib/kea/hooks/libdhcp_lease_cmds.so"
            },
            {
                "library": "/usr/lib/kea/hooks/libdhcp_ha.so",
                "parameters": {
                    "high-availability": [ {
                        "this-server-name": "{{ ha_node_name }}",
                        "mode": "load-balancing",
                        "heartbeat-delay": 5000,
                        "max-response-delay": 10000,
                        "max-ack-delay": 5000,
                        "max-unacked-clients": 2,
                        "sync-timeout": 60000,
                        "peers": [
                            {
                                "name": "node1",
                                "url": "http://{{ ha_peer1_ip }}:{{ service.ports.tcp.http }}/",
                                "role": "primary"
                            },
                            {
                                "name": "node2",
                                "url": "http://{{ ha_peer2_ip }}:{{ service.ports.tcp.http }}/",
                                "role": "secondary"
                            }
                        ]
                    } ]
                }
            }
        ]{% endif %}
    }
}